pipeline {
    agent {label "shabnam"}
environment{
    SCANNER_HOME= tool('sonar-scanner')
}

    stages {

     stage('Clean Workspace') {
            steps {
                cleanWs()
        }
    }
        stage('Git Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/princekumar404/Wanderlust-Mega-Project.git'
            }
        }
        stage('SonarQube Analysis') {
            steps {
              withSonarQubeEnv('sonar-server') {
                sh '''$SCANNER_HOME/bin/sonar-scanner -Dsonar.projectName=wanderlust \
                    -Dsonar.projectKey=wanderlust -Dsonar.sources=. '''
                }
            }
        }
         stage('Quality Gate') {
            steps {
                timeout(time: 1, unit: 'MINUTES') {
                waitForQualityGate abortPipeline: true
            }
        }
  }
        stage('Trivy FS Scan') {
            steps {
                sh 'trivy fs --format table -o trivy-report.html .'
            }
        }
         stage('Docker Build') {
            steps {
                sh 'docker build -t my-project ./frontend'
            }
        }
         stage('Docker image Scan') {
            steps {
                sh 'trivy image my-project --format table -o docker-image.json'
            }
        }
         stage('Login to Amazon ECR') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'aws-cred'
                ]]) {
                    sh '''
                   aws ecr get-login-password --region ap-south-1 \
                   | docker login --username AWS --password-stdin 794248400220.dkr.ecr.ap-south-1.amazonaws.com
                   '''
                }
            }
        }        
         stage('Tag Image & Push Image') {
                 steps {
                sh 'docker tag my-project:latest 794248400220.dkr.ecr.ap-south-1.amazonaws.com/wanderlust-project:latest'
                sh 'docker push 794248400220.dkr.ecr.ap-south-1.amazonaws.com/wanderlust-project:latest'
            }
        }
        stage('Deploy') {
            steps {
                sh 'docker compose up -d '
            }
        }
    }
}
